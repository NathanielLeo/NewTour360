<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tour 360 ƒêa C·∫£nh v·ªõi Pannellum</title>
    <!-- T·∫£i Pannellum t·ª´ CDN -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    <!-- Google API & Picker -->
    <script
      type="text/javascript"
      src="https://apis.google.com/js/api.js"
    ></script>
    <script
      type="text/javascript"
      src="https://accounts.google.com/gsi/client"
      async
      defer
    ></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f4;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .container {
        max-width: 1100px;
        width: 100%;
        padding: 20px;
        text-align: center;
        margin: auto;
      }
      h1 {
        color: #f5b50a;
        margin-bottom: 20px;
      }
      .main-flex {
        display: flex;
        flex-direction: row;
        gap: 32px;
        width: 100%;
        align-items: flex-start;
        justify-content: center;
      }
      .left-panel {
        flex: 0 0 380px;
        max-width: 420px;
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 18px;
      }
      .right-panel {
        flex: 1 1 0;
        min-width: 0;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: stretch;
      }
      .form-container {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 0;
      }
      .upload-section {
        background: rgba(255, 255, 255, 0.05);
        border: 2px dashed rgba(0, 0, 0, 0.1);
        border-radius: 12px;
        padding: 40px;
        text-align: center;
        margin-bottom: 20px;
      }
      .upload-icon i {
        font-size: 60px;
        color: #808080ba;
        padding-bottom: 20px;
      }
      .upload-text {
        font-size: 16px;
        margin-bottom: 8px;
        color: gray;
      }
      .upload-subtext {
        font-size: 12px;
        opacity: 0.6;
        color: gray;
      }
      #uploadForm {
        margin-top: 20px;
      }
      #panorama {
        display: none;
      }
      .upload-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        width: 300px;
      }
      .btn-secondary {
        background: transparent;
        border: 1px solid rgb(245, 181, 10, 0.5);
        color: gray;
        padding: 10px 5px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background 0.3s, color 0.3s;
      }
      .btn-secondary[type="submit"] {
        background: linear-gradient(45deg, #8b5cf6, #a855f7);
        border: none;
        color: white;
        font-weight: 600;
        max-width: 100px;
        margin: 0 auto;
        justify-content: center;
      }
      .btn-secondary:hover {
        background: rgba(139, 92, 246, 0.1);
        color: #8b5cf6;
      }
      .image-list {
        margin: 20px 0 0 0;
        text-align: left;
      }
      .image-list ul {
        list-style: none;
        padding: 0;
      }
      .image-list li {
        background-color: #fff;
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .image-list h3 {
        color: #f5b50a;
      }
      .image-list button {
        background-color: #f5b50a;
        padding: 5px 10px;
        font-size: 14px;
        border: none;
        border-radius: 4px;
        color: #fff;
        cursor: pointer;
        transition: background 0.3s;
      }
      .image-list button:hover {
        background-color: #f5b50a;
      }
      .right-panel #viewer {
        width: 100%;
        height: 500px;
        border-radius: 8px;
        overflow: hidden;
        display: none;
      }
      .right-panel #viewer.active {
        display: block;
      }
      /* Responsive */
      @media (max-width: 900px) {
        .main-flex {
          flex-direction: column;
          gap: 0;
        }
        .left-panel,
        .right-panel {
          max-width: 100%;
          width: 100%;
        }
        .right-panel {
          margin-top: 24px;
        }
      }
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .modal {
        background: #fff;
        border-radius: 10px;
        padding: 32px 24px 24px 24px;
        max-width: 350px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.18);
        text-align: center;
      }
      .modal h4,
      h2 {
        color: #c00;
        margin-bottom: 12px;
      }
      .modal p {
        color: #333;
        margin-bottom: 18px;
      }
      .modal .modal-actions {
        display: flex;
        gap: 16px;
        justify-content: center;
      }
      .modal .modal-btn {
        padding: 8px 18px;
        border-radius: 6px;
        border: none;
        font-size: 15px;
        cursor: pointer;
      }
      .modal .modal-btn.confirm {
        background: #007bff;
        color: #fff;
      }
      .modal .modal-btn.cancel {
        background: #eee;
        color: #333;
      }
      /* ƒëƒÉng xu·∫•t  */
      .logout-btn {
        position: fixed;
        top: 1rem;
        left: 1rem;
        padding: 0.5rem 1rem;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
      }

      .logout-btn:hover {
        background: #c82333;
      }
      #selectedFiles {
        margin-top: 8px;
        text-align: center;
        font-size: 12px;
        color: #8b5cf6;
        display: flex;
        flex-direction: row;
        justify-content: center;
        gap: 6px;
        flex-wrap: wrap;
      }
      #selectedFiles div {
        background: #f3f0ff;
        border-radius: 12px;
        padding: 3px 10px;
        font-size: 12px;
        color: #8b5cf6;
        margin: 2px 0;
        display: inline-block;
        box-shadow: 0 1px 3px rgba(139, 92, 246, 0.08);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>T·∫°o Tour 360 ƒêa C·∫£nh</h1>
      <div class="main-flex">
        <div class="left-panel">
          <div class="form-container">
            <div class="upload-section">
              <div class="upload-icon">
                <i class="fa-solid fa-image fa-3x"></i>
              </div>
              <div class="upload-text">K√©o th·∫£ ho·∫∑c ch·ªçn ·∫£nh 360</div>
              <div class="upload-subtext">
                ƒê·ªãnh d·∫°ng JPG, PNG & dung l∆∞·ª£ng t·ªëi ƒëa 10 MB
              </div>
              <form id="uploadForm">
                <input type="file" id="panorama" accept="image/*" multiple />
                <div class="upload-buttons">
                  <button
                    type="button"
                    class="btn-secondary"
                    onclick="document.getElementById('panorama').click();"
                  >
                    <i class="fa-solid fa-arrow-up-from-bracket"></i> T·∫£i l√™n
                  </button>
                  <button
                    type="button"
                    class="btn-secondary"
                    id="addFromDriveBtn"
                  >
                    <i class="fab fa-google-drive"></i> Google Drive
                  </button>
                </div>
                <div style="margin-top: 12px; text-align: center">
                  <button
                    type="submit"
                    class="btn-secondary"
                    style="width: 100%"
                  >
                    T·∫°o Tour
                  </button>
                </div>
              </form>
              <p class="upload-subtext" style="margin-top: 10px">
                Ho·∫∑c k√©o th·∫£ file v√†o khu v·ª±c n√†y.
              </p>
              <div
                id="selectedFiles"
                style="
                  margin-top: 8px;
                  text-align: left;
                  font-size: 13px;
                  color: #8b5cf6;
                "
              ></div>
            </div>
          </div>

          <div class="image-list">
            <h3>Danh s√°ch t·∫£i l√™n</h3>
            <ul id="imageList"></ul>
          </div>
        </div>
        <div class="right-panel">
          <div id="viewer"></div>
        </div>
      </div>
      <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
          <h2>L∆∞u √Ω</h2>
          <h4>ƒê√¢y kh√¥ng ph·∫£i ·∫£nh 360</h4>
          <p>
            ·∫¢nh b·∫°n ch·ªçn kh√¥ng ph·∫£i panorama 360, n·∫øu xem s·∫Ω b·ªã l·ªói h√¨nh. B·∫°n
            v·∫´n mu·ªën th√™m ·∫£nh n√†y?
          </p>
          <div class="modal-actions">
            <button class="modal-btn confirm" id="modalConfirm">
              Ch·∫≠p nh·∫≠n
            </button>
            <button class="modal-btn cancel" id="modalCancel">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const viewerContainer = document.getElementById("viewer");
      const imageList = document.getElementById("imageList");
      let panorama = null;
      let images = [];
      let pendingFiles = [];
      let pendingIndex = 0;

      // Google Drive Picker API integration
      // You must replace the below with your own credentials from Google Cloud Console
      const GOOGLE_CLIENT_ID =
        "814268602064-fg8v1i69lts85si1h1g3364ji1p85q4q.apps.googleusercontent.com"; // <-- Thay b·∫±ng client_id th·∫≠t
      const GOOGLE_API_KEY = "AIzaSyBlkYHO7b7dnK8Zig6dJ_YWDNlPJvxOHF4"; // <-- Thay b·∫±ng apiKey th·∫≠t
      const GOOGLE_APP_ID = "814268602064"; // <-- Thay b·∫±ng appId th·∫≠t
      const GOOGLE_SCOPES = ["https://www.googleapis.com/auth/drive.readonly"];
      let oauthToken;

      function onApiLoad() {
        gapi.load("picker", {});
      }

      let tokenClient;
      function onAuthApiLoad(callback) {
        if (!tokenClient) {
          tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: GOOGLE_SCOPES.join(" "),
            callback: (tokenResponse) => {
              oauthToken = tokenResponse.access_token;
              callback();
            },
          });
        }
        tokenClient.requestAccessToken();
      }

      function createPicker() {
        if (oauthToken) {
          const picker = new google.picker.PickerBuilder()
            .addView(google.picker.ViewId.DOCS_IMAGES)
            .setOAuthToken(oauthToken)
            .setDeveloperKey(GOOGLE_API_KEY)
            .setAppId(GOOGLE_APP_ID)
            .setCallback(pickerCallback)
            .build();
          picker.setVisible(true);
        } else {
          onAuthApiLoad(createPicker);
        }
      }

      function pickerCallback(data) {
        if (data.action === google.picker.Action.PICKED) {
          const file = data.docs[0];
          const fileId = file.id;
          const fileName = file.name;
          if (!oauthToken) {
            alert("Kh√¥ng c√≥ token x√°c th·ª±c Google Drive!");
            return;
          }
          // S·ª≠ d·ª•ng Google Drive API ƒë·ªÉ l·∫•y blob ·∫£nh v·ªõi header h·ª£p l·ªá
          fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
            headers: {
              Authorization: `Bearer ${oauthToken}`,
            },
          })
            .then((response) => {
              if (!response.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i ·∫£nh t·ª´ Google Drive!");
              return response.blob();
            })
            .then((blob) => {
              const ext = fileName.split('.').pop();
              const mimeType = blob.type || (ext === 'png' ? 'image/png' : 'image/jpeg');
              const imageFile = new File([blob], fileName, { type: mimeType });
              isPanorama360(imageFile, function (isPano) {
                if (isPano) {
                  addImage(imageFile);
                } else {
                  showModal(
                    function () {
                      addImage(imageFile);
                    },
                    function () {}
                  );
                }
              });
            })
            .catch((err) => {
              alert("Kh√¥ng th·ªÉ t·∫£i ·∫£nh t·ª´ Google Drive. Vui l√≤ng th·ª≠ l·∫°i!");
            });
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        const addFromDriveBtn = document.getElementById("addFromDriveBtn");
        if (addFromDriveBtn) {
          addFromDriveBtn.addEventListener("click", function () {
            // Load Picker API if not loaded
            if (typeof gapi === "undefined" || typeof google === "undefined") {
              alert("Google API ch∆∞a s·∫µn s√†ng. Vui l√≤ng th·ª≠ l·∫°i sau.");
              return;
            }
            if (
              !GOOGLE_CLIENT_ID ||
              !GOOGLE_API_KEY ||
              !GOOGLE_APP_ID ||
              GOOGLE_CLIENT_ID.includes("YOUR_CLIENT_ID")
            ) {
              alert(
                "B·∫°n c·∫ßn c·∫•u h√¨nh GOOGLE_CLIENT_ID, GOOGLE_API_KEY, GOOGLE_APP_ID trong m√£ ngu·ªìn."
              );
              return;
            }
            onApiLoad();
            createPicker();
          });
        }
      });

      // Drag-and-drop upload
      const uploadSection = document.querySelector(".upload-section");
      const fileInput = document.getElementById("panorama");
      const selectedFilesDiv = document.getElementById("selectedFiles");
      uploadSection.addEventListener("dragover", function (e) {
        e.preventDefault();
        e.stopPropagation();
        uploadSection.style.borderColor = "#8b5cf6";
        uploadSection.style.background = "rgba(139,92,246,0.08)";
      });
      uploadSection.addEventListener("dragleave", function (e) {
        e.preventDefault();
        e.stopPropagation();
        uploadSection.style.borderColor = "rgba(0, 0, 0, 0.1)";
        uploadSection.style.background = "rgba(255,255,255,0.05)";
      });
      uploadSection.addEventListener("drop", function (e) {
        e.preventDefault();
        e.stopPropagation();
        uploadSection.style.borderColor = "rgba(0, 0, 0, 0.1)";
        uploadSection.style.background = "rgba(255,255,255,0.05)";
        const files = Array.from(e.dataTransfer.files).filter((f) =>
          f.type.startsWith("image/")
        );
        if (files.length === 0) {
          alert("Vui l√≤ng thÔøΩÔøΩÔøΩ file ·∫£nh h·ª£p l·ªá!");
          return;
        }
        // ƒê∆∞a file v√†o input v√† x·ª≠ l√Ω nh∆∞ submit form
        fileInput.files = createFileList(files);
        updateSelectedFiles(files);
        document
          .getElementById("uploadForm")
          .dispatchEvent(new Event("submit"));
      });
      // Helper: T·∫°o FileList t·ª´ m·∫£ng File
      function createFileList(files) {
        const dataTransfer = new DataTransfer();
        files.forEach((f) => dataTransfer.items.add(f));
        return dataTransfer.files;
      }
      // Hi·ªán t√™n file v·ª´a ch·ªçn
      fileInput.addEventListener("change", function () {
        updateSelectedFiles(Array.from(fileInput.files));
      });
      function updateSelectedFiles(files) {
        if (!files || files.length === 0) {
          selectedFilesDiv.innerHTML = "";
          return;
        }
        selectedFilesDiv.innerHTML = files
          .map((f) => `<div>üñºÔ∏è ${f.name}</div>`)
          .join("");
      }

      // Hi·ªán modal c·∫£nh b√°o ·∫£nh kh√¥ng ph·∫£i panorama 360
      function showModal(confirmCallback, cancelCallback) {
        const overlay = document.getElementById("modalOverlay");
        overlay.style.display = "flex";
        document.getElementById("modalConfirm").onclick = function () {
          overlay.style.display = "none";
          confirmCallback();
        };
        document.getElementById("modalCancel").onclick = function () {
          overlay.style.display = "none";
          if (cancelCallback) cancelCallback();
        };
      }

      // Ki·ªÉm tra ·∫£nh c√≥ ph·∫£i panorama 360 kh√¥ng (t·ªâ l·ªá width/height > 1.8)
      function isPanorama360(img, callback) {
        const image = new window.Image();
        image.onload = function () {
          const ratio = image.width / image.height;
          callback(ratio > 1.8);
        };
        image.onerror = function () {
          callback(false);
        };
        image.src = URL.createObjectURL(img);
      }

      // X·ª≠ l√Ω form th√™m ·∫£nh
      document.getElementById("uploadForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const fileInput = document.getElementById("panorama");
        const files = Array.from(fileInput.files);
        if (files.length === 0) {
          alert("Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt h√¨nh ·∫£nh!");
          return;
        }
        pendingFiles = files;
        pendingIndex = 0;
        handleNextFile();
      });

      function handleNextFile() {
        if (pendingIndex >= pendingFiles.length) {
          document.getElementById("panorama").value = "";
          selectedFilesDiv.innerHTML = "";
          return;
        }
        const file = pendingFiles[pendingIndex];
        isPanorama360(file, function (isPano) {
          if (isPano) {
            addImage(file);
            pendingIndex++;
            handleNextFile();
          } else {
            showModal(
              function () {
                addImage(file);
                pendingIndex++;
                handleNextFile();
              },
              function () {
                pendingIndex++;
                handleNextFile();
              }
            );
          }
        });
      }

      function addImage(file) {
        const imageUrl = URL.createObjectURL(file);
        images.push({ name: file.name, url: imageUrl });
        updateImageList();
        autoStartTour();
      }

      // C·∫≠p nh·∫≠t danh s√°ch ·∫£nh
      function updateImageList() {
        imageList.innerHTML = "";
        images.forEach((image, index) => {
          const li = document.createElement("li");
          li.innerHTML = `
            <span>${image.name}</span>
            <div style="display: flex; gap: 8px;">
              <button onclick="viewSingleImage(${index})">Xem</button>
              <button class="btn-delete" style="background:#e53935;" onclick="deleteImageConfirm(${index})">X√≥a</button>
            </div>
          `;
          imageList.appendChild(li);
        });
      }

      // X√°c nh·∫≠n x√≥a ·∫£nh
      window.deleteImageConfirm = function (index) {
        const overlay = document.getElementById("modalOverlay");
        overlay.querySelector("h2").textContent = "X√°c nh·∫≠n";
        overlay.querySelector("h4").textContent = "B·∫°n c√≥ mu·ªën x√≥a ·∫£nh n√†y?";
        overlay.querySelector(
          ".modal p"
        ).textContent = `·∫¢nh: ${images[index].name}`;
        overlay.querySelector("#modalConfirm").style.display = "";
        showModal(
          function () {
            images.splice(index, 1);
            updateImageList();
            if (
              images.length === 0 &&
              viewerContainer.classList.contains("active")
            ) {
              viewerContainer.classList.remove("active");
            }
            autoStartTour();
          },
          function () {}
        );
      };

      // Xem ·∫£nh ƒë∆°n l·∫ª
      window.viewSingleImage = function (index) {
        if (panorama) {
          panorama.destroy();
        }
        panorama = pannellum.viewer("viewer", {
          type: "equirectangular",
          panorama: images[index].url,
          autoLoad: true,
          showControls: true,
          showFullscreenCtrl: true,
          showZoomCtrl: true,
          compass: true,
          title: `·∫¢nh: ${images[index].name}`,
          author: "Ng∆∞·ªùi d√πng",
          mouseZoom: true,
          draggable: true,
        });
        viewerContainer.classList.add("active");
      };

      // T·ª± ƒë·ªông kh·ªüi t·∫°o tour ƒëa c·∫£nh khi c√≥ ·∫£nh m·ªõi
      function autoStartTour() {
        if (panorama) {
          panorama.destroy();
        }
        if (images.length === 0) {
          viewerContainer.classList.remove("active");
          return;
        }
        // T·∫°o c·∫•u h√¨nh tour ƒëa c·∫£nh
        const scenes = {};
        images.forEach((image, index) => {
          scenes[`scene-${index}`] = {
            type: "equirectangular",
            panorama: image.url,
            title: `C·∫£nh: ${image.name}`,
            author: "Ng∆∞·ªùi d√πng",
            compass: true,
            hotSpots: [],
          };
          // Th√™m hotspot ƒë·ªÉ chuy·ªÉn ƒë·∫øn c·∫£nh k·∫ø ti·∫øp v√† tr∆∞·ªõc ƒë√≥
          if (images.length > 1) {
            const nextIndex = (index + 1) % images.length;
            const prevIndex = (index - 1 + images.length) % images.length;
            scenes[`scene-${index}`].hotSpots.push({
              pitch: 0,
              yaw: 90,
              type: "scene",
              text: `ƒêi ƒë·∫øn ${images[nextIndex].name}`,
              sceneId: `scene-${nextIndex}`,
            });
            scenes[`scene-${index}`].hotSpots.push({
              pitch: 0,
              yaw: -90,
              type: "scene",
              text: `ƒêi ƒë·∫øn ${images[prevIndex].name}`,
              sceneId: `scene-${prevIndex}`,
            });
          }
        });
        // Kh·ªüi t·∫°o Pannellum v·ªõi tour ƒëa c·∫£nh
        panorama = pannellum.viewer("viewer", {
          default: {
            firstScene: "scene-0",
            autoLoad: true,
            showControls: true,
            showFullscreenCtrl: true,
            showZoomCtrl: true,
            compass: true,
            mouseZoom: true,
            draggable: true,
          },
          scenes: scenes,
        });
        viewerContainer.classList.add("active");
      }

      // //ƒëƒÉng nh·∫≠p b·∫£o m·∫≠t
      // (function () {
      //   // Ki·ªÉm tra x√°c th·ª±c
      //   const folderName = window.location.pathname
      //     .split("/")
      //     .filter((p) => p)
      //     .slice(-2)[0];
      //   if (!localStorage.getItem(`auth_${folderName}`)) {
      //     window.location.href = "login.html";
      //     return;
      //   }

      //   // Hi·ªÉn th·ªã n·ªôi dung n·∫øu ƒë√£ x√°c th·ª±c
      //   document.getElementById("content").classList.add("visible");

      //   // H√†m ƒëƒÉng xu·∫•t
      //   window.logout = function () {
      //     localStorage.removeItem(`auth_${folderName}`);
      //     window.location.href = "../";
      //   };
      // })();
      
    </script>
  </body>
</html>
